<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>






<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="cuihaonan123" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.1" />






<meta name="description" content="IOS开发，喜欢刨根问底，热爱技术，热爱Swift、React-Native、JS，混合开发。">
<meta property="og:type" content="website">
<meta property="og:title" content="崔浩楠 Blog">
<meta property="og:url" content="http://asution.github.io/index.html">
<meta property="og:site_name" content="崔浩楠 Blog">
<meta property="og:description" content="IOS开发，喜欢刨根问底，热爱技术，热爱Swift、React-Native、JS，混合开发。">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="崔浩楠 Blog">
<meta name="twitter:description" content="IOS开发，喜欢刨根问底，热爱技术，热爱Swift、React-Native、JS，混合开发。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Penulis'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://asution.github.io/"/>





  <title>崔浩楠 Blog</title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?e5729e13053393358fa3bafb9bbb2b33";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>










  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">崔浩楠 Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">倘能生存，我当然仍要学习。</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Beranda
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Arsip
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://asution.github.io/2017/06/14/网络是怎样连接的/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Haonan Cui deployment">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="崔浩楠 Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/14/网络是怎样连接的/" itemprop="url">网络是怎样连接的</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Diposting di</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-06-14T10:31:14+08:00">
                2017-06-14
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="探索之旅看点"><a href="#探索之旅看点" class="headerlink" title="探索之旅看点"></a>探索之旅看点</h3><p>1.当从浏览器中输入URL(Uniform Resource Locator)后，浏览器会从网址(URL)开始解析.<br>2.根据解析后的数据来生成请求消息.<br>3.浏览器”委托操作系统”向Web服务器发送请求并告诉系统接收方的IP地址(浏览器需要向DNS服务器查询域名对应的IP地址)<br>4.全世界的上万台DNS服务器接力完成IP地址的查询<br>5.查询IP地址后,向Web服务器发送消息</p>
<h3 id="HTTP请求"><a href="#HTTP请求" class="headerlink" title="HTTP请求"></a>HTTP请求</h3><h4 id="简介"><a href="#简介" class="headerlink" title="简介:"></a>简介:</h4><p>HTTP(Hypertext Transfer Protocol) 翻译过来为”超文本传输协议”.是在1989年在”欧洲核子研究组织”发起,由”万维网协会和互联网工程任务组”制定标准 — HTTP 1.1. 于2015年5月以<a href="https://zh.wikipedia.org/wiki/RFC" target="_blank" rel="external">RFC</a> 7540发布2.0版本.<br>HTTP最初的目的是为了提供一种发布和接收HTML页面的方法。通过HTTP或者HTTPS协议请求的资源由<a href="https://zh.wikipedia.org/wiki/统一资源标识符" target="_blank" rel="external">统一资源标识符</a>.<br>统一资源标识符:(URI : Uniform Resource Indentifier)</p>
<h4 id="生成HTTP请求"><a href="#生成HTTP请求" class="headerlink" title="生成HTTP请求"></a>生成HTTP请求</h4><p>当我们在输入框填入URL时,例如:<a href="http://www.google.com" target="_blank" rel="external">http://www.google.com</a> . 开头的http:// 就是我们接下来要详细聊的. 注:现在大部分的网址都引入了安全的<strong>“HTTPS”</strong>,它的安全机制后面说明.<br>除了http://, 还有像 ftp:// file:// mailto:// 等.<br>之所以有很多类型，主要原因是因为浏览器支持很多功能,可以用来在FTP服务器上传/下载文件 使用 ftp://<br>读取客户端本地文件 使用  file://<br>发送电子邮件时 mailto:// 等,这里做不一一列举,我们知道了开头的内容是什么作用就可以.</p>
<p>可以将开头部分理解为访问时的”协议类型”,尽管后面的写法不同,但开头决定了后面的写法,所以不会造成混乱的现象.</p>
<p>1.HTTP定义了客户端与服务器之间交互的内容与步骤,客户端向服务器发送请求包括两个内容: “对什么” , “进行怎样的操作”<br>“对什么”也称为URI,上面提到过 例如: “/dir/index.html” “/dir/program.cgi” , 存放一个网页数据的文件名或者是一个CGI程序(Web服务器调用程序调用其他程序的规则)的文件名. URI的功能不止这些,还有可以直接使用 “http:”  开头的URL作为URI, 可以写各种访问目标.统称URI.<br>“进行怎样的操作”: 就是我们常见的一些例如 Get, Post, Head, Options, Put, Delete, Trace, Connect, 通过这样的方法可以对服务器的数据进行”增删改查”操作.<br>2.Web服务器收到消息后根据URI进行解析,并返回响应消息,在响应消息的开头有一个状态码,我们可以通过返回的状态码来判断本次消息的成功或失败,失败原因等.<br>3.当浏览器收到Web服务器响应消息后, 无论成功或失败, 都会将响应的数据显示到屏幕上.<br>4.HTTP整个工作完成</p>
<h4 id="请求头"><a href="#请求头" class="headerlink" title="请求头:"></a>请求头:</h4><p>当URL无法全部满足我们需要的条件时,我们就需要添加一些附加信息在请求中,这时侯就会使用到head(<a href="https://zh.wikipedia.org/wiki/HTTP头字段列表" target="_blank" rel="external">HTTP头字段列表</a>).</p>
<h4 id="响应头"><a href="#响应头" class="headerlink" title="响应头:"></a>响应头:</h4><p>当消息发送到Web服务器后,就会收到对应的响应消息,与请求头唯一的区别就在第一行中,第一行的内容为状态吗和响应短语,表示请求的执行结果.状态码是一个数字,它用来向程序告知执行结果, 下表列出了基本常用的状态码概要:</p>
<table>
<thead>
<tr>
<th>状态码</th>
<th style="text-align:center">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>1xx</td>
<td style="text-align:center">请求的处理进度与情况</td>
</tr>
<tr>
<td>2xx</td>
<td style="text-align:center">成功</td>
</tr>
<tr>
<td>3xx</td>
<td style="text-align:center">需要进一步操作</td>
</tr>
<tr>
<td>4xx</td>
<td style="text-align:center">客户端错误</td>
</tr>
<tr>
<td>5xx</td>
<td style="text-align:center">服务器错误</td>
</tr>
</tbody>
</table>
<p>当网页信息为纯文字时,则直接显示到屏幕上,请求到此结束,如果还有图片资源需要显示,则在源码中插入标签,用来占用图片显示的位置并且向服务请求获取响应图片显示在预留空间中.<br>注:每一张图片都会向服务器请求一次,如3张图片,一个URI,则需要向服务器请求4次,请求与响应都是一对一的.</p>
<h4 id="向DNS服务器查询域名-Web服务器对应的IP地址"><a href="#向DNS服务器查询域名-Web服务器对应的IP地址" class="headerlink" title="向DNS服务器查询域名/Web服务器对应的IP地址"></a>向DNS服务器查询域名/Web服务器对应的IP地址</h4><p>这里先做一个IP的简介: TCP/IP网络是由无数个子网组成,子网通过发送到集线器,转发到最近的路由器上,接下来会根据消息自动判断下一个要发送的路由器,通过不断的发送,最终到达指定路由器.而这个子网就是IP地址,如现实中的XX号XX室,相当于消息访问目标和地址.<br>tip: 在IP地址无法区分是网络号,主机号时通过<a href="https://zh.wikipedia.org/wiki/子网" target="_blank" rel="external">子网掩码</a>这种附加信息来区分.</p>
<p>这里还有一个<strong>效率问题</strong>,域名转换为IP地址提高了运行效率, 因为IP地址的长度为32比特(4字节),相对域名最短几十个字节,最长255字节而言,减少了路由器的负担,传送数据的时间也相对减少.</p>
<p>在转换域名与IP地址之间的机制就称为DNS.<br>那么,DNS是如何查询IP的呢?其实很简单,就是调用包含在”Socket库”中的解析器来实现的,当我们通过DNS来查询IP时,通过将Socket中的解析器调用结果,存储到浏览器的内存中,待浏览器向Web服务器发送消息时, 从内存中取出对应的IP地址和HTTP一起返回给操作系统进行解析.<br>一句话来概括就是: <strong>域名查询IP地址时,浏览器会使用Socket库中的解析器</strong></p>
<p>那么<strong>解析器</strong>内部是如何实现的?</p>
<h4 id="解析器的内部实现原理"><a href="#解析器的内部实现原理" class="headerlink" title="解析器的内部实现原理"></a>解析器的内部实现原理</h4><p>这里进行一个简单的介绍:<br>1.浏览器/应用程序 存储的IP内存空间 = 使用高级编程语言,调用Socket库根据域名来调用方法<br>2.Scoket库生成发送给DNS服务器的查询消息<br>3.委托给操作系统内部协议栈将消息发送出去(操作系统内部网络控制软件,也叫 TCP/IP驱动 等)<br>4.通过网卡发送给DNS服务器<br>5.查询到结果后通过网卡返回查询结果并保存到内存中<br>6.继续执行下一行代码,待调用时机,在对应内存中取出查询到的IP地址</p>
<p>tip: 只要是在DNS服务器中注册的,都可以作为Web服务器的域名来使用<br>一句话来概括就是: <strong>DNS服务器会从域名与IP地址的对照表中查找相应的记录并返回对应的IP地址</strong></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://asution.github.io/2017/06/07/iOS开发者应该知道的/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Haonan Cui deployment">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="崔浩楠 Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/06/07/iOS开发者应该知道的/" itemprop="url">iOS开发者应该知道的</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Diposting di</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-06-07T14:26:45+08:00">
                2017-06-07
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今年的 WWDC 新增的看点无疑是最新的操作系统，以及出现的两个框架 :  一个是用来机器学习的 Core ML 框架，另一个是 AR 现实的 ARKit。<br>在最新的Xcode beat 9 中，也将编译速度进行了提升，还有几个小Tips的更新</p>
<h4 id="Core-ML"><a href="#Core-ML" class="headerlink" title="Core ML"></a>Core ML</h4><p><a href="https://developer.apple.com/documentation/coreml" target="_blank" rel="external">Core ML 官方文档</a><br>在大会上，苹果宣布了一系列面向开发者的机器学习API，包括面部识别、自然语言处理，这些API集成入苹果的 Core ML框架。<br>那么什么是<strong>机器学习</strong>，我这里简单做一下介绍：你可以把机器学习看做一个盒子模型，当你给予他输入（调用函数），他就会给出输出（将一个机器学习算法应用到一个训练数据集之后所得到的结果。然后该模型可以基于新的输入数据而进行预测。比如，如果一个模型在一个地区的历史房价数据上进行了训练，那么它就可能能够根据房子的卧室和浴室数量来预测房价。）。经过大幅度的修复以及训练，可以对数据给出较高的准确率。<br>它是人工智能的核心，是使计算机具有智能的根本途径。<br>更多好玩的东西参照官网一起来尝尝鲜.。</p>
<h4 id="ARKit"><a href="#ARKit" class="headerlink" title="ARKit"></a>ARKit</h4><p>我们可以看出今年苹果将大力推广AR，在发布会中使用Keynote演示的部分极为精彩。在演示环节中，苹果展示了改进版《口袋妖怪 GO》，ARkit 工具套件能够让游戏中的怪兽以一种更为现实的方式在街道和公园周围跳跃。<br>ARkit 可以在手机屏幕中的桌面上投射一个虚拟咖啡杯，而且当灯光靠近的时候咖啡杯的阴影会发生改变。<br>一艘飞艇正在攻击一个敌方的前哨。强调了 ARKit 在平板游戏中所表现出的极强的空间感知能力。</p>
<p>ARKit同样降低了开发成本，使得我们开发者可以快速投入AR行列。</p>
<h4 id="Xcode的几个小Tips"><a href="#Xcode的几个小Tips" class="headerlink" title="Xcode的几个小Tips"></a>Xcode的几个小Tips</h4><h5 id="无线调试"><a href="#无线调试" class="headerlink" title="无线调试"></a>无线调试</h5><p>有兴趣需要下载 iOS 11的同学请进入链接 <a href="https://pan.baidu.com/s/1o7LCPmi" target="_blank" rel="external">iOS 11 描述文件下载</a>。<br>打开描述文件后重启手机就可以安装最新beat版本的 iOS 11拉。<br>无线调试可谓是一项非常棒的功能，通过局域网可以进行无线测试机调试，方法也非常的简单，只需安装上面的描述文件后，更新成为iOS11后。<br>1.打开Xcode菜单：Windows-&gt;Device and Simulators。找到连接上的设备，把Connect via network选项打勾。<br>2.选中手机右键，在出来的选项卡中选择一个Connect via IP Address项<br>3.输入ip地址<br>4.待出现地球标志后表示设置成功<br>这时就可以进行无线调试啦</p>
<h5 id="编译速度"><a href="#编译速度" class="headerlink" title="编译速度"></a>编译速度</h5><p>源码编辑器已经为了惊人的速度而完全重建。最新编译系统是使用Swift重写，速度提升很多。</p>
<h5 id="Name-Color"><a href="#Name-Color" class="headerlink" title="Name Color"></a>Name Color</h5><p>可以在xcassets里添加颜色，取名后可以在代码或者IB中使用这个颜色图片</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://asution.github.io/2017/05/31/计算机中的进制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Haonan Cui deployment">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="崔浩楠 Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/31/计算机中的进制/" itemprop="url">计算机中的进制</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Diposting di</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-31T15:35:33+08:00">
                2017-05-31
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="热身题-1"><a href="#热身题-1" class="headerlink" title="热身题 1)"></a>热身题 1)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">1.32位是几个字节？</div><div class="line">2.二进制数01011100转换成十进制数是多少?</div><div class="line">3.二进制数00001111左移二位后，会变成原数的几倍？</div><div class="line">4.补码形式表示的8位二进制数11111111，用十进制表示？</div><div class="line">5.补码形式表示的8位二进制数10101010，用16位二进制数表示?</div><div class="line">6.反转部分图形模式时，使用的是什么逻辑运算？</div></pre></td></tr></table></figure>
<p>计算机内部是由IC（Integrated Circuit）这种电子部件构成，CPU和内存也是IC的一种。IC的所有引脚只有直流电压0V或5V两个状态。也就是说，IC的一个引脚，只能表示两个状态。<br>二进制由 0，1 表示。</p>
<p>二进制的位数一般是8位，16位，32位······ 也就是8的倍数，计算机所处理的基本单位是8位二进制数。8位二进制数为一个字节。字节为基本的信息计量单位。</p>
<p>如果小于存储数据的字节数，那么高位上就由 0 填补。<br>8位  ： 100111 -&gt; 00100111<br>16位： 100111 -&gt; 0000000000100111<br>32位处理器则一次可以处理4字节二进制数信息</p>
<p>无论是十进制数还是文字等信息，最终都会转成二进制表示信息。计算机不会区分它是数值、文字、还是某种图片的模式等，具体进行何种处理，取决于程序编写方式。</p>
<h4 id="什么是二进制数"><a href="#什么是二进制数" class="headerlink" title="什么是二进制数"></a>什么是二进制数</h4><p>原理：二进制数的值转换成十进制数的值，只需要将二进制的各位数的值和位权相乘，然后将相乘结果相加即可。</p>
<p>例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">39这个数值， 拆分来看是 3 * 10 + 9 * 1 。</div><div class="line">这里各个位数的数值相乘的 10 和 1 ，就是位权。</div><div class="line">如果放入二进制数中来表达</div><div class="line">即第1位是2的0次幂，第2位是2的1次幂，第3位是2的2次幂。依次类推。</div><div class="line">在十进制中 基数 为10 ， 二进制中基数为 2。</div></pre></td></tr></table></figure></p>
<p>二进制数00100111用十进制数表示是39，因为:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(0 * 128) + (0 * 64) + (1 * 32) + (0 * 16) + (0 * 8) + (1 * 4) </div><div class="line">+ (1 * 2) + (1 * 1) = 39</div></pre></td></tr></table></figure></p>
<h5 id="左移运算符"><a href="#左移运算符" class="headerlink" title="左移运算符"></a>左移运算符</h5><p>“&lt;&lt;”，左移一位为原数值的2倍，以此类推<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">a = 10;</div><div class="line">b = a &lt;&lt; 2;</div><div class="line"></div><div class="line">左移后空出来的位数由0进行补位，但只适合 &lt;&lt;，</div><div class="line">&gt;&gt; 时，用来填充右移后空出来的高位值，有0，1两种形式</div></pre></td></tr></table></figure></p>
<h5 id="补数"><a href="#补数" class="headerlink" title="补数"></a>补数</h5><p>二进制中表示负数时将最高位作为符号来使用，一般把最高位成为符号位，符号位是0表示正数，1表示负数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">0 0 0 0 0 0 0 1</div><div class="line">最高位指向第一个位，也就是第一个0</div></pre></td></tr></table></figure></p>
<p>计算机在做减法运算时，实际上内部是在做加法运算。为此，在表示负数时就需要使用 二进制的补数，补数就是用正数来表示负数。<br>其实获取补数其实就是对二进制的各位数值全部取反，然后结果加1，例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">0 0 0 0 0 0 0 1 原始数值</div><div class="line">1 1 1 1 1 1 1 0 取反</div><div class="line">1 1 1 1 1 1 1 1 加一，完成获取补数</div></pre></td></tr></table></figure>
<p>例 1 - 1，也就是 1 + (-1)，答案是0。如果将-1表示为10000001来计算，结果则不为0。<br>错误的运算：00000001 + 10000001 = 10000010<br>正确的运算：00000001 + 11111111   = 100000000<br>如果-1表示为11111111进行运算，出现了最高位溢出的情况，不过，对于溢出的位，计算机会直接忽略掉。<br>100000000 这个9位二进制会被认为是 00000000。<br>补数求解的变换方法就是 “ 取反 + 1 ”。</p>
<h5 id="右移运算符"><a href="#右移运算符" class="headerlink" title="右移运算符"></a>右移运算符</h5><p>“&gt;&gt;”，区分逻辑右移和算术右移<br>逻辑右移：在二进制数的值表示图形模式而非数值时，移位后需要在最高位补0<br>算术右移：将二进制数作为带符号的数值进行运算时，移位后要在最高位填充 0 或 1。如果值为负数，那么右移后空出来的最高位补1，就可以正确实现1/2,1/4,1/8等。如果是正数，需要在最高位补0即可。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">-4（11111100）右移两位</div><div class="line">此时，逻辑右移下结果就会变为 00111111，也就是十进制63，并非为 -4的1/4。</div><div class="line">而算术右移的情况，结果就会变为11111111，补数表示也就是-1。</div></pre></td></tr></table></figure></p>
<p>只有在右移时需要区分，左移只需要补0即可。</p>
<p>符号扩充：在保持值不变的前提下将其转成16位和32位二进制数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">8位  : 01111111</div><div class="line">16位 : 0000000001111111</div></pre></td></tr></table></figure></p>
<p>不管是证书还是补位数表示的负数，都只需用符号位的值（0或1）填充高位即可。</p>
<h5 id="逻辑运算"><a href="#逻辑运算" class="headerlink" title="逻辑运算"></a>逻辑运算</h5><p>逻辑运算指对二进制数各数字位的0和1分别进行处理的运算，包括 逻辑非(NOT)、逻辑与(AND)、逻辑或(OR)、逻辑异或(XOR，exclusive or)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">逻辑非（NOT）指的是 0 变 1， 1 变 0 的取反操作</div><div class="line">0 -&gt; 1 </div><div class="line">1 -&gt; 0</div><div class="line"></div><div class="line">逻辑与（and）两个数都是1时结果为1，其他情况为0</div><div class="line">0  0 -&gt; 0</div><div class="line">0  1 -&gt; 0</div><div class="line">1  0 -&gt; 0</div><div class="line">1  1 -&gt; 1</div><div class="line"></div><div class="line">逻辑或（or）至少一方是1时结果为1，其他情况为0</div><div class="line">0  0 -&gt; 0</div><div class="line">0  1 -&gt; 1</div><div class="line">1  0 -&gt; 1</div><div class="line">1  1 -&gt; 1</div><div class="line"></div><div class="line">逻辑异或（xor）排斥相同数值的运算</div><div class="line">0  0 -&gt; 0</div><div class="line">0  1 -&gt; 1</div><div class="line">1  0 -&gt; 1</div><div class="line">1  1 -&gt; 0</div></pre></td></tr></table></figure></p>
<h4 id="热身题-1-答案"><a href="#热身题-1-答案" class="headerlink" title="热身题 1) 答案"></a>热身题 1) 答案</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">1.  4</div><div class="line">2.  92</div><div class="line">3.  4倍</div><div class="line">4.  -1</div><div class="line">5.  1111111110101010</div><div class="line">6.  XOR运算</div></pre></td></tr></table></figure>
<h4 id="热身题-2"><a href="#热身题-2" class="headerlink" title="热身题 2)"></a>热身题 2)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">1.二进制数0.1用十进制数表示是多少？</div><div class="line">2.用小数点后又3位的二进制数，能表示十进制数0.625吗？</div><div class="line">3.将小数分为符号、尾数、基数、指数4部分进行表现的形式成为什么？</div><div class="line">4.二进制数的基数是多少？</div><div class="line">5.通过把0作为述职范围的中间值，从而在不适用符号位的情况下表示负数的表示方法称为什么？</div><div class="line">6.10101100.01010011二进制，用十六进制表示是多少？</div></pre></td></tr></table></figure>
<p>例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">1011.0011 二进制数转换为十进制数</div><div class="line">小数点前的部分的位权，第1位是2的0次幂，第2位是1次幂，依次类推。</div><div class="line">小数点后面的位权，第1位是-1次幂，第2位是-2次幂，依次类推。</div><div class="line"></div><div class="line">(1 * 8) + (0 * 4) + (1 * 2) + (1 * 1) + (0 * 0.5) + (0 * 0.25) + </div><div class="line">(1 * 0.125) + (1 * 0.0625) = 11.1875;</div></pre></td></tr></table></figure></p>
<p>那为什么计算机会计算错误呢? 因为 “有一些十进制数的小数无法转换成二进制数”。 例 0.1，就无法用二进制数正确表示，小数后面即使有几百位也无法表示。<br>小数点后4位用二进制数表示时的数值范围 0.0000 ~ 0.1111，因此，这里只能表示 0.5 、0.25、0.00625 这几个二进制数小数点后面的权位组合而成的小数。<br>例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">二进制：0.0000  0.0001   ···</div><div class="line">十进制：0       0.0625   ···</div></pre></td></tr></table></figure></p>
<p>在 0 和 0.0625中间的小数，就无法用小数点后4位数的二进制数来表示。依次类推。 十进制数0.1转换为二进制数时会变成 1100这样的循环小数，计算机功这个功能有限的设备，无法处理循环小数，当遇到此类情况，会进行四舍五入。</p>
<p><strong>浮点数由 符号、尾数、基数、指数组成</strong><br>在 64位中称为双精度浮点数，符号部分 1位，指数部分 11位，尾数部分 52位。<br>在 32位中称为单精度浮点数，符号部分 1位，指数部分 8位，尾数部分 23位。</p>
<p>双精度浮点数和单精度浮点数在表示同一数值时使用的位数不同。双精度浮点数能够表示的数值范围较大。</p>
<h4 id="小数"><a href="#小数" class="headerlink" title="小数"></a>小数</h4><h5 id="符号"><a href="#符号" class="headerlink" title="符号"></a>符号</h5><p><strong>符号：使用一个数据位来表示数值的符号。该数据为1表示负，0表示 “正或者0”。数值的大小用尾数部分和指数部分来表示。</strong>这里不用纠结它们是做什么的后面接着看。</p>
<h5 id="尾数"><a href="#尾数" class="headerlink" title="尾数"></a>尾数</h5><p><strong>尾数部分</strong>使用<strong>正则表达式</strong>。在数学中，例如 十进制数0.75就有很多种表现形式。虽然它们表示的都是同一个数值，但因为表现方法太多，计算机处理相对麻烦，所以为了方便处理，需要定制一套规则。<br>例如， 十进制的浮点数应该遵循“小数点前面是0，小数点后面第1位不能是0” 这样的规定。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">0.75就是 0.75 * 10 的0次幂。</div></pre></td></tr></table></figure>
<p>当然在二进制数中也同样适用，在二进制中 ，将小数点前面的值固定为1的正则表达式。</p>
<h5 id="指数"><a href="#指数" class="headerlink" title="指数"></a>指数</h5><p><strong>指数部分</strong>中使用EXCESS系统，使用这种方法主要是为了表示负数时不能使用符号位。在某些情况下，指数部分需要通过 <strong>负OO次幂的形式来表示负数</strong>。<br>EXCESS系统指，通过将指数部分表示范围的中间值设为0，是的附属不需要用符号来表示。<br>我们将EXCESS系统比作 1 ~ 13 这些值。 取中间的5这这个值当成0，7就表示+2，3就表示-2。这个规则就是EXCESS系统。</p>
<p>例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">static void number()&#123;</div><div class="line">    float data;</div><div class="line">    unsigned long buff;</div><div class="line">    int i;</div><div class="line">    char s[34];</div><div class="line">    </div><div class="line">    //以单精度浮点数储存</div><div class="line">    data = (float)0.75;</div><div class="line">    </div><div class="line">    //将数据复制到 4 字节长度的整数变量 buff 中</div><div class="line">    memcpy(&amp;buff, &amp;data, 4);</div><div class="line">    </div><div class="line">    for (i = 33; i &gt;= 0; i--) &#123;</div><div class="line">        if (i == 1 || i == 10) &#123;</div><div class="line">            //将各个部分划分</div><div class="line">            s[i] = &apos;-&apos;;</div><div class="line">        &#125; else &#123;</div><div class="line">            if(buff % 2 == 1)&#123;</div><div class="line">                s[i] = &apos;1&apos;;</div><div class="line">            &#125;else&#123;</div><div class="line">                s[i] = &apos;0&apos;;</div><div class="line">            &#125;</div><div class="line">            buff /= 2;</div><div class="line">        &#125;</div><div class="line">        printf(&quot;%lu\n&quot;,buff);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    s[33] = &apos;\0&apos;;</div><div class="line">    </div><div class="line">    printf(&quot;%s\n&quot;,s);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出，十进制0.75用单精度浮点数表示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">0-01111110-1000000000000000000000</div></pre></td></tr></table></figure>
<p>对应的符号部分为 0</p>
<p>指数部分为 01111110，十进制数为126，用EXCESS系统表现就是 -1 (126 - 127)</p>
<p>剩余为尾数 1.1000000000000000000000 基于正则表达式规则，将二进制数转为十进制数，结果为 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">(1 * 2 的 0 次幂) + (1 * 2 的 -1 次幂) = 1.5</div><div class="line">因此 这个单精度浮点数表示的就是 “ +1.5 * 2 的 -1 次幂 ” = +0.75</div></pre></td></tr></table></figure>
<h4 id="热身题-2-答案"><a href="#热身题-2-答案" class="headerlink" title="热身题 2)答案"></a>热身题 2)答案</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">1. 0.5 二进制数的小数点后第一位位权是 2的-1次幂，也就相当于</div><div class="line">   0.1 -&gt; 1 * 0.5  = 0.5 十进制数就是0.5</div><div class="line">2. 可以表示，转换成二进制数为0.101</div><div class="line">3. 浮点数  （符号 尾数 * 基数的指数次幂）</div><div class="line">4. 基数为2</div><div class="line">5. EXCESS</div><div class="line">6. AC.53 整数部分和小数部分一样，二进制数的4位相当于十六进制的1位</div></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/1481580-8beab4b0a0c6796f.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://asution.github.io/2017/05/12/IOS网络请求之-NSURLSession/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Haonan Cui deployment">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="崔浩楠 Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/12/IOS网络请求之-NSURLSession/" itemprop="url">IOS网络请求之-NSURLSession</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Diposting di</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-12T17:38:55+08:00">
                2017-05-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>NSURLSession在iOS7.0时被Apple提出后，虽然Apple一直对其良好的API设计大力推广。<br>在下面我们将会知道：</p>
<ol>
<li>我们为什么从NSURLConnection转移为NSURLSession？</li>
<li>NSURLSession 的基本用法</li>
<li>AFN对NSURLSession的封装</li>
</ol>
<p>2015年5月RFC 7540正式发表的下一代HTTP协议，是1999年来HTTP 1.1发布后的首个更新。相对于前一个版本，HTTP /2以快著称。如下图，对相同图片、相同服务器的下载，在不同协议下所需的时间：<br><img src="https://user-gold-cdn.xitu.io/2016/11/29/0ac9b2ad6c9a01f22267516258f30f48.jpg" alt=""></p>
<p>ios9之后，NSURLSession开始支持HTTP/2<br><strong>HTTP/2 意味着更快的网络连接速度</strong><br>在<a href="https://developer.apple.com/reference/foundation/nsurlsessionconfiguration/1407597-httpmaximumconnectionsperhost?language=objc" target="_blank" rel="external">苹果官方文档</a>中，对属性<strong> HTTPMaximumConnectionsPerHost</strong>这样描述<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Discussion</div><div class="line">This property determines the maximum number of simultaneous connections made to each host by tasks within sessions based on this configuration.</div><div class="line">This limit is per session, so if you use multiple sessions, your app as a whole may exceed this limit. Additionally, depending on your connection to the Internet, a session may use a lower limit than the one you specify.</div><div class="line">The default value is 6 in macOS, or 4 in iOS.</div></pre></td></tr></table></figure></p>
<p>此属性根据此配置确定会话中的任务对每个主机的最大并发连接数，MacOS中的默认值为6，iOS中的默认值为4。</p>
<p>先看一个最简单的网络请求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">NSURLSessionConfiguration *sessionConfiguration = [NSURLSessionConfiguration defaultSessionConfiguration];</div><div class="line"></div><div class="line">NSURLSession *session = [NSURLSession sessionWithConfiguration:sessionConfiguration delegate:self delegateQueue:[[NSOperationQueue alloc] init]];</div><div class="line">    </div><div class="line">NSURLRequest *request = [[NSURLRequest alloc]initWithURL:[NSURL URLWithString:URLString]];</div><div class="line">    </div><div class="line">NSURLSessionDataTask *dataTask = [session dataTaskWithRequest:request];</div><div class="line"></div><div class="line">[dataTask resume];</div></pre></td></tr></table></figure></p>
<p>NSRULSession 网络请求系统包括3方面:<br>session、configuration、Task</p>
<h4 id="NSURLSession"><a href="#NSURLSession" class="headerlink" title="NSURLSession"></a>NSURLSession</h4><p>我们从头文件入手<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">// 初始化Session</div><div class="line">@property (class, readonly, strong) NSURLSession *sharedSession;</div><div class="line">+ (NSURLSession *)sessionWithConfiguration:(NSURLSessionConfiguration *)configuration;</div><div class="line">+ (NSURLSession *)sessionWithConfiguration:(NSURLSessionConfiguration *)configuration delegate:(nullable id &lt;NSURLSessionDelegate&gt;)delegate delegateQueue:(nullable NSOperationQueue *)queue;</div><div class="line"></div><div class="line">// 属性及代理</div><div class="line">@property (readonly, retain) NSOperationQueue *delegateQueue;</div><div class="line">@property (nullable, readonly, retain) id &lt;NSURLSessionDelegate&gt; delegate;</div><div class="line">@property (readonly, copy) NSURLSessionConfiguration *configuration;</div><div class="line"></div><div class="line">// dataTask</div><div class="line">- (NSURLSessionDataTask *)dataTaskWithRequest:(NSURLRequest *)request;</div><div class="line">- (NSURLSessionDataTask *)dataTaskWithURL:(NSURL *)url;</div><div class="line"></div><div class="line">// uploadTask</div><div class="line">- (NSURLSessionUploadTask *)uploadTaskWithRequest:(NSURLRequest *)request fromFile:(NSURL *)fileURL;</div><div class="line">- (NSURLSessionUploadTask *)uploadTaskWithRequest:(NSURLRequest *)request fromData:(NSData *)bodyData;</div><div class="line">- (NSURLSessionUploadTask *)uploadTaskWithStreamedRequest:(NSURLRequest *)request;</div><div class="line"></div><div class="line">// downloadTask</div><div class="line">- (NSURLSessionDownloadTask *)downloadTaskWithRequest:(NSURLRequest *)request;</div><div class="line">- (NSURLSessionDownloadTask *)downloadTaskWithURL:(NSURL *)url;</div><div class="line">- (NSURLSessionDownloadTask *)downloadTaskWithResumeData:(NSData *)resumeData;</div></pre></td></tr></table></figure></p>
<p>苹果也为NSURLSession 配置了block的回调版本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">// NSURLSessionDataTask</div><div class="line">- (NSURLSessionDataTask *)dataTaskWithRequest:(NSURLRequest *)request completionHandler:(void (^)(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error))completionHandler;</div><div class="line">- (NSURLSessionDataTask *)dataTaskWithURL:(NSURL *)url completionHandler:(void (^)(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error))completionHandler;</div><div class="line"></div><div class="line">// NSURLSessionUploadTask</div><div class="line">- (NSURLSessionUploadTask *)uploadTaskWithRequest:(NSURLRequest *)request fromFile:(NSURL *)fileURL completionHandler:(void (^)(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error))completionHandler;</div><div class="line">- (NSURLSessionUploadTask *)uploadTaskWithRequest:(NSURLRequest *)request fromData:(nullable NSData *)bodyData completionHandler:(void (^)(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error))completionHandler;</div><div class="line"></div><div class="line">// NSURLSessionDownloadTask</div><div class="line">- (NSURLSessionDownloadTask *)downloadTaskWithRequest:(NSURLRequest *)request completionHandler:(void (^)(NSURL * _Nullable location, NSURLResponse * _Nullable response, NSError * _Nullable error))completionHandler;</div><div class="line">- (NSURLSessionDownloadTask *)downloadTaskWithURL:(NSURL *)url completionHandler:(void (^)(NSURL * _Nullable location, NSURLResponse * _Nullable response, NSError * _Nullable error))completionHandler;</div><div class="line">- (NSURLSessionDownloadTask *)downloadTaskWithResumeData:(NSData *)resumeData completionHandler:(void (^)(NSURL * _Nullable location, NSURLResponse * _Nullable response, NSError * _Nullable error))completionHandler;</div></pre></td></tr></table></figure></p>
<p>如何使用？ 我们从网络加载一张图片<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">NSURLSession *session = [NSURLSession sharedSession];</div><div class="line">NSURLRequest *request = [[NSURLRequest alloc]initWithURL:[NSURL URLWithString:ImageURL]];</div><div class="line">NSURLSessionDataTask *sessionDataTask = [session dataTaskWithRequest:request completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) &#123;</div><div class="line">    UIImage *image = [[UIImage alloc]initWithData:data];</div><div class="line">&#125;];</div><div class="line">[sessionDataTask resume];</div></pre></td></tr></table></figure></p>
<h4 id="NSURLSessionConfiguration"><a href="#NSURLSessionConfiguration" class="headerlink" title="NSURLSessionConfiguration"></a>NSURLSessionConfiguration</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">// 默认的配置 , 缓存存储在磁盘上</div><div class="line">@property (class, readonly, strong) NSURLSessionConfiguration *defaultSessionConfiguration;</div><div class="line">// 不会创建持久性存储的缓存.</div><div class="line">@property (class, readonly, strong) NSURLSessionConfiguration *ephemeralSessionConfiguration;</div><div class="line">// 允许程序在后台进行上传下载工作</div><div class="line">+ (NSURLSessionConfiguration *)backgroundSessionConfigurationWithIdentifier:(NSString *)identifier;</div><div class="line">// 配置缓存策略</div><div class="line">@property NSURLRequestCachePolicy requestCachePolicy;</div><div class="line">// 请求超时</div><div class="line">@property NSTimeInterval timeoutIntervalForRequest;</div><div class="line">// 添加请求头</div><div class="line">@property (nullable, copy) NSDictionary *HTTPAdditionalHeaders;</div></pre></td></tr></table></figure>
<h4 id="NSURLSessionTask"><a href="#NSURLSessionTask" class="headerlink" title="NSURLSessionTask"></a>NSURLSessionTask</h4><p>苹果并没有公开让我们使用 NSURLSessionTask ，而是只能使用它的子类 ： </p>
<ol>
<li>NSURLSessionDataTask 一般网络请求</li>
<li>NSURLSessionDownloadTask 下载大型文件等</li>
<li>NSURLSessionUploadTask 处理上传请求，图片或文件</li>
</ol>
<p>Task Delegate 继承关系<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">1. NSURLSessionTask (抽象类,NSURLSessionTaskDelegate)</div><div class="line">  2. NSURLSessionDataTask (NSURLSessionDataDelegate)</div><div class="line">    3.  NSURLSessionUploadTask (NSURLSessionDataDelegate)</div><div class="line">        4. NSURLSessionDownloadTask (NSURLSessionDownloadDelegate)</div><div class="line"></div><div class="line">1. NSURLSessionDelegate</div><div class="line">  2. NSURLSessionTaskDelegate</div><div class="line">    3. NSURLSessionDataDelegate</div><div class="line">      4. NSURLSessionDownloadDelegate</div></pre></td></tr></table></figure></p>
<p>在初始化时，我们只需指定对应的delegate，这个手机避免了多次设计delegate，根据不同的task实现不同的delegate。</p>
<p>从头文件看各个delegate的作用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">// NSURLSessionDelegate</div><div class="line">//当一个session遇到系统错误或者未检测到的错误</div><div class="line">- (void)URLSession:(NSURLSession *)session didBecomeInvalidWithError:(nullable NSError *)error</div><div class="line">//当请求需要认证、或者https证书认证</div><div class="line">- (void)URLSession:(NSURLSession *)session didReceiveChallenge:(NSURLAuthenticationChallenge *)challenge</div><div class="line"> completionHandler:(void (^)(NSURLSessionAuthChallengeDisposition disposition, NSURLCredential * _Nullable credential))completionHandler;</div><div class="line">//如果应用进入后台、这个方法会被调用。我们在这里可以对session发起的请求做各种操作。</div><div class="line">- (void)URLSessionDidFinishEventsForBackgroundURLSession:(NSURLSession *)session ;</div><div class="line"></div><div class="line">// NSURLSessionTaskDelegate</div><div class="line">/*当请求重定向的时候调用这个方法。我们必须设置一个新的`NSURLRequest`对象传入completionHandler来重定向新的请求，但是当`session`是background模式的时候，这个方法不会被调用。 */</div><div class="line">- (void)URLSession:(NSURLSession *)session task:(NSURLSessionTask *)task</div><div class="line">willPerformHTTPRedirection:(NSHTTPURLResponse *)response</div><div class="line">        newRequest:(NSURLRequest *)request</div><div class="line"> completionHandler:(void (^)(NSURLRequest * _Nullable))completionHandler;</div><div class="line">/*当请求需要认证的时候调用这个方法。如果没有实现这个代理，那么请求认证这个过程不会被调用。*/</div><div class="line">- (void)URLSession:(NSURLSession *)session task:(NSURLSessionTask *)task</div><div class="line">didReceiveChallenge:(NSURLAuthenticationChallenge *)challenge</div><div class="line"> completionHandler:(void (^)(NSURLSessionAuthChallengeDisposition disposition, NSURLCredential * _Nullable credential))completionHandler;</div><div class="line">/* 如果请求需要一个新的请求体时，这个方法就会被调用。比如认证失败的时候，我们可以通过这个机会从新认证。 */</div><div class="line">- (void)URLSession:(NSURLSession *)session task:(NSURLSessionTask *)task</div><div class="line"> needNewBodyStream:(void (^)(NSInputStream * _Nullable bodyStream))completionHandler;</div><div class="line">/*当我们上传数据的时候，我们可以通过这个代理方法获取上传进度。 */</div><div class="line">- (void)URLSession:(NSURLSession *)session task:(NSURLSessionTask *)task</div><div class="line">   didSendBodyData:(int64_t)bytesSent</div><div class="line">    totalBytesSent:(int64_t)totalBytesSent</div><div class="line">totalBytesExpectedToSend:(int64_t)totalBytesExpectedToSend;</div><div class="line">/* 当task的统计信息收集好了以后，调用这个方法。 */</div><div class="line">- (void)URLSession:(NSURLSession *)session task:(NSURLSessionTask *)task didFinishCollectingMetrics:(NSURLSessionTaskMetrics *)metrics;</div><div class="line">/*当一个task出错的时候，会调用这个方法。如果error是nil，也会调用这个方法，表示task完成。*/</div><div class="line">- (void)URLSession:(NSURLSession *)session task:(NSURLSessionTask *)task</div><div class="line">didCompleteWithError:(nullable NSError *)error;</div><div class="line"></div><div class="line">// NSURLSessionDownloadDelegate</div><div class="line">/*当一个下载task任务完成以后*/</div><div class="line">- (void)URLSession:(NSURLSession *)session downloadTask:(NSURLSessionDownloadTask *)downloadTask</div><div class="line">didFinishDownloadingToURL:(NSURL *)location;</div><div class="line">/*获取下载进度 */</div><div class="line">- (void)URLSession:(NSURLSession *)session downloadTask:(NSURLSessionDownloadTask *)downloadTask</div><div class="line">      didWriteData:(int64_t)bytesWritten</div><div class="line"> totalBytesWritten:(int64_t)totalBytesWritten</div><div class="line">totalBytesExpectedToWrite:(int64_t)totalBytesExpectedToWrite;</div><div class="line">/*重启一个下载任务。如果下载出错，`NSURLSessionDownloadTaskResumeData`里面包含重新开始下载的数据。 */</div><div class="line">- (void)URLSession:(NSURLSession *)session downloadTask:(NSURLSessionDownloadTask *)downloadTask</div><div class="line"> didResumeAtOffset:(int64_t)fileOffset</div><div class="line">expectedTotalBytes:(int64_t)expectedTotalBytes;</div></pre></td></tr></table></figure></p>
<p>参考文献<br><a href="https://github.com/Draveness/Analyze/blob/master/contents/AFNetworking/AFNetworking%20%E7%9A%84%E6%A0%B8%E5%BF%83%20AFURLSessionManager%EF%BC%88%E4%BA%8C%EF%BC%89.md#NSURLSession" target="_blank" rel="external">AFNetWorking 的核心 AFURLSessionManager</a><br><a href="https://juejin.im/entry/58f6d0be0ce463006bc9d919" target="_blank" rel="external">AFNetWorking 源码之 AFURLSessionManager</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://asution.github.io/2017/05/11/OC的block详细解析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Haonan Cui deployment">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="崔浩楠 Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/11/OC的block详细解析/" itemprop="url">OC的block详细解析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Diposting di</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-11T16:51:23+08:00">
                2017-05-11
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Block 就是 Objective-C 语言对于闭包的实现。</p>
<p>在编程语言中，闭包是函数或引用环境的函数的一个函数或引用 - 一个存储对该函数的每个非局部变量（也称为自由变量或更高值）的引用的表。<strong>by wikipedia translate</strong></p>
<p>这篇文章主要解析一下几点</p>
<ol>
<li>block 从源码分析其原理</li>
<li>block 的内存管理</li>
<li>block 通过什么方式来修改外部变量</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">struct Block_descriptor &#123;</div><div class="line">    unsigned long int reserved;</div><div class="line">    unsigned long int size;</div><div class="line">    void (*dispose)(void *);</div><div class="line">    void (*copy)(void *dst, void *src);</div><div class="line">&#125;;</div><div class="line">struct Block_layout &#123;</div><div class="line">    void *isa;</div><div class="line">    int flags;</div><div class="line">    int reserved;</div><div class="line">    void (*invoke)(void *, ...);</div><div class="line">    struct Block_descriptor *descriptor;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>一个block由几部分构成：</p>
<ol>
<li>isa指针，所有对象都存在该指针，用于实现对象的相关功能</li>
<li>flags， 用于表示一些block的附加信息</li>
<li>reserved，保留变量值</li>
<li>invoke，指向实现函数调用地址</li>
<li>descriptor，描述信息，copy函数指针，<br>size大小{(sizeof(struct __main_block_impl_0))}等</li>
</ol>
<p>接下来我们去了解一下block的3个类型，其类型影响着block的生命周期以及内存管理，从类型中可以看出在使用block的时候我们要注意什么，如何进行内存的管理。</p>
<hr>
<h3 id="block类型，block-从源码分析其原理"><a href="#block类型，block-从源码分析其原理" class="headerlink" title="block类型，block 从源码分析其原理"></a>block类型，block 从源码分析其原理</h3><p>首先我们看一下block的几个类型：<br>NSConcreteGlobalBlock：全局静态block,不会访问外部变量<br>NSConcreteStackBlock： 存在栈中的block,当函数作用域结束或者返回时被销毁<br>NSConcreteMallocBlock：存在堆中的block,内部由引用计数器管理是否销毁</p>
<p><strong>使用 clang 命令可以查看源码</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clang -rewrite-objc main.m</div></pre></td></tr></table></figure></p>
<h3 id="NSConcreteGlobalBlock-类型"><a href="#NSConcreteGlobalBlock-类型" class="headerlink" title="NSConcreteGlobalBlock 类型"></a>NSConcreteGlobalBlock 类型</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">int main(int argc, char * argv[]) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        ^&#123; &#125;;</div><div class="line">        return 0;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>将上面的代码通过命令得到main.cpp文件, 剔除无关代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">struct __block_impl &#123;</div><div class="line">    void *isa;</div><div class="line">    int Flags;</div><div class="line">    int Reserved;</div><div class="line">    void *FuncPtr;</div><div class="line">&#125;;</div><div class="line">struct __main_block_impl_0 &#123;</div><div class="line">    struct __block_impl impl;</div><div class="line">    struct __main_block_desc_0* Desc;</div><div class="line">    __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int flags=0) &#123;</div><div class="line">        impl.isa = &amp;_NSConcreteStackBlock;</div><div class="line">        impl.Flags = flags;</div><div class="line">        impl.FuncPtr = fp;</div><div class="line">        Desc = desc;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">static void __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</div><div class="line">&#125;</div><div class="line">static struct __main_block_desc_0 &#123;</div><div class="line">    size_t reserved;</div><div class="line">    size_t Block_size;</div><div class="line">&#125; __main_block_desc_0_DATA = &#123; 0, sizeof(struct __main_block_impl_0) &#125;;</div><div class="line">int main(int argc, char * argv[]) &#123;</div><div class="line">    /* @autoreleasepool */ &#123; __AtAutoreleasePool __autoreleasepool; </div><div class="line">        ((void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA));</div><div class="line">        return 0;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>__main_block_impl_0 其实就是block的实现,从它我们可以看出：</p>
<ol>
<li>block由isa、Flags、Reserved 组成，它其实就是一个对象</li>
<li>源码中 isa 指向了<strong> _NSConcreteStackBlock</strong>，但是在开启ARC 的 LLVM中 block 应该是指向 <strong>_NSConcreteGlobalBlock</strong>类型。</li>
<li>impl为函数指针，指向 __main_block_func_0</li>
</ol>
<h3 id="NSConcreteStackBlock类型"><a href="#NSConcreteStackBlock类型" class="headerlink" title="NSConcreteStackBlock类型"></a>NSConcreteStackBlock类型</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">int main(int argc, char * argv[]) &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        int stackValue;</div><div class="line">        ^&#123; stackValue; &#125;;</div><div class="line">        return 0;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>源码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">struct __main_block_impl_0 &#123;</div><div class="line">  struct __block_impl impl;</div><div class="line">  struct __main_block_desc_0* Desc;</div><div class="line">  int stackValue;</div><div class="line">  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int _stackValue, int flags=0) : stackValue(_stackValue) &#123;</div><div class="line">    impl.isa = &amp;_NSConcreteStackBlock;</div><div class="line">    impl.Flags = flags;</div><div class="line">    impl.FuncPtr = fp;</div><div class="line">    Desc = desc;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">static void __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</div><div class="line">  int stackValue = __cself-&gt;stackValue; // bound by copy</div><div class="line"> stackValue; &#125;</div><div class="line"></div><div class="line">static struct __main_block_desc_0 &#123;</div><div class="line">  size_t reserved;</div><div class="line">  size_t Block_size;</div><div class="line">&#125; __main_block_desc_0_DATA = &#123; 0, sizeof(struct __main_block_impl_0)&#125;;</div><div class="line">int main(int argc, char * argv[]) &#123;</div><div class="line">    /* @autoreleasepool */ &#123; __AtAutoreleasePool __autoreleasepool; </div><div class="line">        int stackValue;</div><div class="line">        ((void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA, stackValue));</div><div class="line">        return 0;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ol>
<li>isa 指向了_NSConcreteStackBlock类型</li>
<li>__main_block_impl_0 中增加了变量 <strong> int stackValue; </strong>，在blokc实际修改变量时，修改的是这个内部的变量，外部的变量不会改变</li>
</ol>
<p>如果使用关键字 <strong> __block </strong> 来修饰stackValue变量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">struct __Block_byref_stackValue_0 &#123;</div><div class="line">  void *__isa;</div><div class="line">__Block_byref_stackValue_0 *__forwarding;</div><div class="line"> int __flags;</div><div class="line"> int __size;</div><div class="line"> int stackValue;</div><div class="line">&#125;;</div><div class="line">struct __main_block_impl_0 &#123;</div><div class="line">  struct __block_impl impl;</div><div class="line">  struct __main_block_desc_0* Desc;</div><div class="line">  __Block_byref_stackValue_0 *stackValue; // by ref</div><div class="line">  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, __Block_byref_stackValue_0 *_stackValue, int flags=0) : stackValue(_stackValue-&gt;__forwarding) &#123;</div><div class="line">    impl.isa = &amp;_NSConcreteStackBlock;</div><div class="line">    impl.Flags = flags;</div><div class="line">    impl.FuncPtr = fp;</div><div class="line">    Desc = desc;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line">static void __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</div><div class="line">  __Block_byref_stackValue_0 *stackValue = __cself-&gt;stackValue; // bound by ref</div><div class="line"> (stackValue-&gt;__forwarding-&gt;stackValue); &#125;</div><div class="line">static void __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) &#123;_Block_object_assign((void*)&amp;dst-&gt;stackValue, (void*)src-&gt;stackValue, 8/*BLOCK_FIELD_IS_BYREF*/);&#125;</div><div class="line"></div><div class="line">static void __main_block_dispose_0(struct __main_block_impl_0*src) &#123;_Block_object_dispose((void*)src-&gt;stackValue, 8/*BLOCK_FIELD_IS_BYREF*/);&#125;</div><div class="line"></div><div class="line">static struct __main_block_desc_0 &#123;</div><div class="line">  size_t reserved;</div><div class="line">  size_t Block_size;</div><div class="line">  void (*copy)(struct __main_block_impl_0*, struct __main_block_impl_0*);</div><div class="line">  void (*dispose)(struct __main_block_impl_0*);</div><div class="line">&#125; __main_block_desc_0_DATA = &#123; 0, sizeof(struct __main_block_impl_0), __main_block_copy_0, __main_block_dispose_0&#125;;</div><div class="line">int main(int argc, char * argv[]) &#123;</div><div class="line">    /* @autoreleasepool */ &#123; __AtAutoreleasePool __autoreleasepool; </div><div class="line">        __attribute__((__blocks__(byref))) __Block_byref_stackValue_0 stackValue = &#123;(void*)0,(__Block_byref_stackValue_0 *)&amp;stackValue, 0, sizeof(__Block_byref_stackValue_0)&#125;;</div><div class="line">;</div><div class="line">        ((void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA, (__Block_byref_stackValue_0 *)&amp;stackValue, 570425344));</div><div class="line">        return 0;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>Block_byref_id_object_copy、</strong>Block_byref_id_object_dispose,以实现对对象内存的管理。其中两者的最后一个参数131表示BLOCK_BYREF_CALLER|BLOCK_FIELD_IS_OBJECT，BLOCK_BYREF_CALLER表示在内部实现中不对a对象进行retain或copy<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">if ((flags &amp; BLOCK_BYREF_CALLER) == BLOCK_BYREF_CALLER) &#123;</div><div class="line">    ...</div><div class="line">    else &#123;</div><div class="line">        // do *not* retain or *copy* __block variables whatever they are</div><div class="line">        _Block_assign((void *)object, destAddr);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ol>
<li>源码中加入了 __Block_byref_stackValue_0 结构体，保存临时变量 stackValue</li>
<li>在<strong>main_block_func_0中使用 ** </strong>forwarding** 来保证变量始终在堆中</li>
<li>__Block_byref_stackValue_0 也是一个对象</li>
<li>我们需要管理相应的内存，在__main_block_desc_0 中加入了copy 和 dispose</li>
</ol>
<h3 id="NSConcreteMallocBlock类型"><a href="#NSConcreteMallocBlock类型" class="headerlink" title="NSConcreteMallocBlock类型"></a>NSConcreteMallocBlock类型</h3><p>NSConcreteMallocBlock 无法查看具体源码，我们可以根据一个实力代码来查看 NSConcreteMallocBlock类型<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">static void *_Block_copy_internal(const void *arg, const int flags) &#123;</div><div class="line">    struct Block_layout *aBlock;</div><div class="line">    const bool wantsOne = (WANTS_ONE &amp; flags) == WANTS_ONE;</div><div class="line"></div><div class="line">    // 1</div><div class="line">    if (!arg) return NULL;</div><div class="line"></div><div class="line">    // 2</div><div class="line">    aBlock = (struct Block_layout *)arg;</div><div class="line"></div><div class="line">    // 3</div><div class="line">    if (aBlock-&gt;flags &amp; BLOCK_NEEDS_FREE) &#123;</div><div class="line">        // latches on high</div><div class="line">        latching_incr_int(&amp;aBlock-&gt;flags);</div><div class="line">        return aBlock;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 4</div><div class="line">    else if (aBlock-&gt;flags &amp; BLOCK_IS_GLOBAL) &#123;</div><div class="line">        return aBlock;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // 5</div><div class="line">    struct Block_layout *result = malloc(aBlock-&gt;descriptor-&gt;size);</div><div class="line">    if (!result) return (void *)0;</div><div class="line"></div><div class="line">    // 6</div><div class="line">    memmove(result, aBlock, aBlock-&gt;descriptor-&gt;size); // bitcopy first</div><div class="line"></div><div class="line">    // 7</div><div class="line">    result-&gt;flags &amp;= ~(BLOCK_REFCOUNT_MASK);    // XXX not needed</div><div class="line">    result-&gt;flags |= BLOCK_NEEDS_FREE | 1;</div><div class="line"></div><div class="line">    // 8</div><div class="line">    result-&gt;isa = _NSConcreteMallocBlock;</div><div class="line"></div><div class="line">    // 9</div><div class="line">    if (result-&gt;flags &amp; BLOCK_HAS_COPY_DISPOSE) &#123;</div><div class="line">        (*aBlock-&gt;descriptor-&gt;copy)(result, aBlock); // do fixup</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>看到这里我们基本理解了block的基本实现，需要注意：</p>
<ol>
<li>如果在block中修改或者使用了外部变量，记得使用_weak typeof(self) weakSelf = self; </li>
<li>在多线程环境下（block中的weakSelf有可能被析构的情况下），需要先将self转为strong指针，避免在运行到某个关键步骤时self对象被析构。</li>
</ol>
<p>参考文献<br><a href="http://www.galloway.me.uk/2013/05/a-look-inside-blocks-episode-3-block-copy/" target="_blank" rel="external">A look inside blocks</a><br><a href="http://www.jianshu.com/p/51d04b7639f1" target="_blank" rel="external">Block技巧与底层解析</a><br><a href="http://blog.devtang.com/2013/07/28/a-look-inside-blocks/" target="_blank" rel="external">谈Objective-C block的实现</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://asution.github.io/2017/05/10/react-native从入门到放弃（4-1）Flexbox布局/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Haonan Cui deployment">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="崔浩楠 Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/10/react-native从入门到放弃（4-1）Flexbox布局/" itemprop="url">react-native从入门到放弃（4.1）Flexbox布局</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Diposting di</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-10T18:00:46+08:00">
                2017-05-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h4><p><a href="http://weibo.com/311290005?from=feed&amp;loc=at&amp;nick=w3cplus&amp;is_hot=1" target="_blank" rel="external">CSS3 Sina</a><br><a href="http://weibo.com/1712131295/CoRnElNkZ?ref=collection&amp;type=comment&amp;sudaref=reactnative.cn&amp;retcode=6102#_rnd1494398944406" target="_blank" rel="external">CSS3 Clexbox 口诀 Sina</a><br><a href="https://www.w3cplus.com/css3/understanding-flexbox-everything-you-need-to-know.html" target="_blank" rel="external">理解Flexbox：你需要知道的一切</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://asution.github.io/2017/05/10/react-native从入门到放弃（4）样式与布局/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Haonan Cui deployment">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="崔浩楠 Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/10/react-native从入门到放弃（4）样式与布局/" itemprop="url">react-native从入门到放弃（4）样式与布局</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Diposting di</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-10T18:00:10+08:00">
                2017-05-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="样式"><a href="#样式" class="headerlink" title="样式"></a>样式</h3><p>使用React Native，您不需要使用特殊语言或语法来定义样式。您只需使用JavaScript设计应用程序。所有的核心组件都接受一个名字命名<strong>style</strong>。样式名称和值通常与CSS在CSS上的工作方式相匹配，除了使用驼峰命名，<strong>backgroundColor</strong>而不是background-color。</p>
<p>style 可以是一个普通的JavaScript对象，还可以传递一个样式数组-<strong>数组中的最后一个样式为最高优先级</strong>，因此可以使用继承样式。</p>
<p>需要引入一个新的 <strong> StyleSheet </strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">import React, &#123; Component &#125; from &apos;react&apos;;</div><div class="line">import &#123; AppRegistry, StyleSheet, Text, View &#125; from &apos;react-native&apos;;</div><div class="line"></div><div class="line">class LotsOfStyles extends Component &#123;</div><div class="line">  render() &#123;</div><div class="line">    return (</div><div class="line">      &lt;View&gt;</div><div class="line">        &lt;Text style=&#123;styles.red&#125;&gt;just red&lt;/Text&gt;</div><div class="line">        &lt;Text style=&#123;styles.bigblue&#125;&gt;just bigblue&lt;/Text&gt;</div><div class="line">        &lt;Text style=&#123;[styles.bigblue, styles.red]&#125;&gt;bigblue, then red&lt;/Text&gt;</div><div class="line">        &lt;Text style=&#123;[styles.red, styles.bigblue]&#125;&gt;red, then bigblue&lt;/Text&gt;</div><div class="line">      &lt;/View&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">const styles = StyleSheet.create(&#123;</div><div class="line">  bigblue: &#123;</div><div class="line">    color: &apos;blue&apos;,</div><div class="line">    fontWeight: &apos;bold&apos;,</div><div class="line">    fontSize: 30,</div><div class="line">  &#125;,</div><div class="line">  red: &#123;</div><div class="line">    color: &apos;red&apos;,</div><div class="line">  &#125;,</div><div class="line">&#125;);</div><div class="line"></div><div class="line">AppRegistry.registerComponent(&apos;AwesomeProject&apos;, () =&gt; LotsOfStyles);</div></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/1481580-88c8cf217dfec716.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="看起来像这样"></p>
<p>更多样式以后可以参考文档<br>facebook: <a href="https://facebook.github.io/react-native/docs/text.html" target="_blank" rel="external">Text组件实现</a><br>China:   <a href="http://reactnative.cn/docs/0.44/text.html" target="_blank" rel="external">Text组件实现 For China</a></p>
<h3 id="Frame-宽高"><a href="#Frame-宽高" class="headerlink" title="Frame (宽高)"></a>Frame (宽高)</h3><h5 id="固定尺寸"><a href="#固定尺寸" class="headerlink" title="固定尺寸"></a>固定尺寸</h5><p>设置组件尺寸的最简单的方法是添加一个固定width和height样式。React Native中的所有尺寸都是无单位的，并且表示密度无关的像素。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">import React, &#123; Component &#125; from &apos;react&apos;;</div><div class="line">import &#123; AppRegistry, View &#125; from &apos;react-native&apos;;</div><div class="line"></div><div class="line">class FixedDimensionsBasics extends Component &#123;</div><div class="line">  render() &#123;</div><div class="line">    return (</div><div class="line">      &lt;View&gt;</div><div class="line">        &lt;View style=&#123;&#123;width: 50, height: 50, backgroundColor: &apos;powderblue&apos;&#125;&#125; /&gt;</div><div class="line">        &lt;View style=&#123;&#123;width: 100, height: 100, backgroundColor: &apos;skyblue&apos;&#125;&#125; /&gt;</div><div class="line">        &lt;View style=&#123;&#123;width: 150, height: 150, backgroundColor: &apos;steelblue&apos;&#125;&#125; /&gt;</div><div class="line">      &lt;/View&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">AppRegistry.registerComponent(&apos;AwesomeProject&apos;, () =&gt; FixedDimensionsBasics);</div></pre></td></tr></table></figure>
<p><img src="http://upload-images.jianshu.io/upload_images/1481580-d5893c7281e0a249.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>以这种方式设置尺寸对于总是以完全相同的大小渲染的组件而言，与屏幕尺寸无关。</p>
<h5 id="Flex组件"><a href="#Flex组件" class="headerlink" title="Flex组件"></a>Flex组件</h5><p>使组件根据可用空间动态扩展和缩小。通常，您将使用flex: 1它来告诉组件填充所有可用空间，并在同一个父项之间在每个其他组件之间均匀分配。空间的分量将采取相比</p>
<p><strong>如果一个组件的父对象的维数大于0，则该组件只能扩展为填充可用空间。如果父项没有固定的width，height或者flex父对象的维度为0，并且flex子控件将不可见。</strong></p>
<p>举个例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">import React, &#123; Component &#125; from &apos;react&apos;;</div><div class="line">import &#123; AppRegistry, View &#125; from &apos;react-native&apos;;</div><div class="line"></div><div class="line">class FlexDimensionsBasics extends Component &#123;</div><div class="line">  render() &#123;</div><div class="line">    return (</div><div class="line">      // Try removing the `flex: 1` on the parent View.</div><div class="line">      // The parent will not have dimensions, so the children can&apos;t expand.</div><div class="line">      // What if you add `height: 300` instead of `flex: 1`?</div><div class="line">      &lt;View style=&#123;&#123;flex: 1&#125;&#125;&gt;</div><div class="line">        &lt;View style=&#123;&#123;flex: 1, backgroundColor: &apos;powderblue&apos;&#125;&#125; /&gt;</div><div class="line">        &lt;View style=&#123;&#123;flex: 2, backgroundColor: &apos;skyblue&apos;&#125;&#125; /&gt;</div><div class="line">        &lt;View style=&#123;&#123;flex: 3, backgroundColor: &apos;steelblue&apos;&#125;&#125; /&gt;</div><div class="line">      &lt;/View&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">AppRegistry.registerComponent(&apos;AwesomeProject&apos;, () =&gt; FlexDimensionsBasics);</div></pre></td></tr></table></figure></p>
<p><img src="http://upload-images.jianshu.io/upload_images/1481580-27a56866ad18047f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://asution.github.io/2017/05/10/react-native从入门到放弃（3-1）RN组件生命周期/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Haonan Cui deployment">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="崔浩楠 Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/10/react-native从入门到放弃（3-1）RN组件生命周期/" itemprop="url">react-native从入门到放弃（3.1）RN组件生命周期</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Diposting di</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-10T18:00:02+08:00">
                2017-05-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>上一章我们看过了state的调用过程，这章我们深入了解一下RN的生命周期<br><img src="http://upload-images.jianshu.io/upload_images/1481580-c4941316654b7990.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="RN组件生命周期三个阶段.png"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://asution.github.io/2017/05/10/react-native从入门到放弃（3）属性与状态/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Haonan Cui deployment">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="崔浩楠 Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/10/react-native从入门到放弃（3）属性与状态/" itemprop="url">react-native从入门到放弃（3）属性与状态</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Diposting di</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-10T17:59:03+08:00">
                2017-05-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><strong>我们可以为大多数组件定制各种参数，用于定制的这些参数就称为props（属性）。</strong></p>
<h3 id="属性的自定义-Props"><a href="#属性的自定义-Props" class="headerlink" title="属性的自定义 Props"></a>属性的自定义 Props</h3><p>以Image 为例，在创建图片的时候，可以传入一个名为source的prop来指定要显示的图片的地址</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">import React, &#123; Component &#125; from &apos;react&apos;;</div><div class="line">import &#123; AppRegistry, Image &#125; from &apos;react-native&apos;;</div><div class="line"></div><div class="line">class AwesomeProject extends Component &#123;</div><div class="line">  render() &#123;</div><div class="line">    let pic = &#123;</div><div class="line">      uri: &apos;https://imgsa.baidu.com/baike/c0%3Dbaike180%2C5%2C5%2C180%2C60/sign=ca5abb5b7bf0f736ccf344536b3cd87c/29381f30e924b899c83ff41c6d061d950a7bf697.jpg</div><div class="line">    &#125;;</div><div class="line">    return (</div><div class="line">      &lt;Image source=&#123;pic&#125; style=&#123;&#123;width: 193, height: 110&#125;&#125; /&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><strong>{pic}</strong>外围的一层括号，我们需要用括号来把pic这个变量嵌入到JSX语句中。括号内部为一个js变量或表达式，需要执行后取值。因此我们可以把任意合法的JavaScript表达式通过括号嵌入到JSX语句中。</p>
<p>自定义的组件也可以使用props，在不同的场景使用不同的属性定制，可以尽量提高自定义组件的复用范畴，在render函数中引用this.props</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">import React, &#123; Component &#125; from &apos;react&apos;;</div><div class="line">import &#123; AppRegistry, Text, View &#125; from &apos;react-native&apos;;</div><div class="line"></div><div class="line">class Greeting extends Component &#123;</div><div class="line">  render() &#123;</div><div class="line">    return (</div><div class="line">      &lt;Text&gt;Hello &#123;this.props.name&#125;!&lt;/Text&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">class AwesomeProject extends Component &#123;</div><div class="line">  render() &#123;</div><div class="line">    return (</div><div class="line">      &lt;View style=&#123;&#123;alignItems: &apos;center&apos;&#125;&#125;&gt;</div><div class="line">        &lt;Greeting name=&apos;Rexxar&apos; /&gt;</div><div class="line">      &lt;/View&gt;</div><div class="line">    );</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>把<strong>name</strong>作为一个属性来定制，这样可以复用来制作不同场景的使用，将<strong>Greeting</strong>写入JSX语句中，用法和内置组件没有任何区别，如果想定义自己的控件将是个不错的选择。</p>
<h3 id="状态-State"><a href="#状态-State" class="headerlink" title="状态 State"></a>状态 State</h3><p>props是在父组件中指定，而且一经指定，在被指定的组件的生命周期中则不再改变。 对于需要改变的数据，我们需要使用state。<br>你需要在constructor中初始化<strong>State</strong>(这是ES6的写法，这里忽略早起ES5)，修改时调用setState方法。<a href="http://es6.ruanyifeng.com/" target="_blank" rel="external">ES6传送门</a></p>
<p>这是一个简单的例子，点击控件触发onPress来记录点击次数，顺便看一下state的调用顺序<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">import React, &#123; Component &#125; from &apos;react&apos;;</div><div class="line">import &#123; AppRegistry, StyleSheet, Text, View , Image&#125; from &apos;react-native&apos;;</div><div class="line"></div><div class="line">class Blink extends Component &#123;</div><div class="line">    constructor(props) &#123;</div><div class="line">        super(props);</div><div class="line">        this.state = &#123;times: 0&#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    timePlus() &#123;</div><div class="line">        let times = this.state.times</div><div class="line">        times ++</div><div class="line"></div><div class="line">        this.setState(&#123;</div><div class="line">            times: times</div><div class="line">        &#125;)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //组件即将安装</div><div class="line">    componentWillMount() &#123;</div><div class="line">        console.log(&apos;componentWillMount&apos;)</div><div class="line">    &#125;</div><div class="line">    render() &#123;</div><div class="line">        console.log(&apos;render&apos;)</div><div class="line">        return(</div><div class="line">        //布局使用创建RN时的默认布局</div><div class="line">           &lt;View style=&#123;styles.container&#125;&gt;</div><div class="line">        &lt;Text style=&#123;styles.welcome&#125; onPress=&#123;this.timePlus.bind(this)&#125;&gt;</div><div class="line">          你点了我 &#123;this.state.times&#125; 次</div><div class="line">        &lt;/Text&gt;</div><div class="line">      &lt;/View&gt;</div><div class="line">        )</div><div class="line">    &#125;</div><div class="line">    //已经安装</div><div class="line">    componentDidMount() &#123;</div><div class="line">        console.log(&apos;componentDidMount&apos;)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //是否需要更新</div><div class="line">    shouldComponentUpdate() &#123;</div><div class="line">        console.log(&apos;shouldComponentUpdate&apos;)</div><div class="line">        return true</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //将要更新 state</div><div class="line">    componentWillUpdate() &#123;</div><div class="line">        console.log(&apos;componentWillUpdate&apos;)</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    //已经更新 中间会调用 render()</div><div class="line">    componentDidUpdate() &#123;</div><div class="line">        console.log(&apos;componentDidUpdate&apos;)</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>我们可以看一下RN的简单生命周期</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1481580-ec75ade5269163e0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>接下来我点击控件触发 onPress<br><img src="http://upload-images.jianshu.io/upload_images/1481580-a942743ff940f974.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>这里大概就是RN State 一个简单的<strong>生命周期</strong><br>理解<br>在真正的应用程序中，当服务器或用户输入到达新数据时，可以设置状态。 还可以使用像Redux这样的状态容器来控制数据流。 在这种情况下，将使用Redux来修改状态，而不是直接调用setState。</p>
<hr>
<p><strong>如果无法加载图片，请在info.plst文件中添加如下配置，支持http方式访问</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"> &lt;key&gt;NSAppTransportSecurity&lt;/key&gt;</div><div class="line"> &lt;dict&gt;</div><div class="line">     &lt;key&gt;NSExceptionDomains&lt;/key&gt;</div><div class="line">     &lt;dict&gt;</div><div class="line">         &lt;key&gt;qq.com&lt;/key&gt;</div><div class="line">         &lt;dict&gt;</div><div class="line">             &lt;key&gt;NSIncludesSubdomains&lt;/key&gt;</div><div class="line">             &lt;true/&gt;</div><div class="line">         &lt;/dict&gt;</div><div class="line">         &lt;key&gt;sina.com.cn&lt;/key&gt;</div><div class="line">         &lt;dict&gt;</div><div class="line">             &lt;key&gt;NSIncludesSubdomains&lt;/key&gt;</div><div class="line">             &lt;true/&gt;</div><div class="line">         &lt;/dict&gt;</div><div class="line">        &lt;/dict&gt;</div><div class="line">&lt;/dict&gt;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://asution.github.io/2017/05/05/react-native从入门到放弃（2）从ios端来看RN运行原理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Haonan Cui deployment">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="崔浩楠 Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/05/05/react-native从入门到放弃（2）从ios端来看RN运行原理/" itemprop="url">react-native从入门到放弃（2）从ios端来看RN运行原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Diposting di</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-05-05T13:12:23+08:00">
                2017-05-05
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>打开我们刚init 的 demo，分析一下他的实现原理</p>
<p>React Native用iOS自带的JavaScriptCore作为JS的解析引擎，但并没有用到JavaScriptCore提供的一些可以让JS与OC互调的特性，而是自己实现了一套机制，这套机制可以通用于所有JS引擎上，在没有JavaScriptCore的情况下也可以用webview代替，实际上项目里就已经有了用webview作为解析引擎的实现，应该是用于兼容iOS7以下没有JavascriptCore的版本。<br>普通的JS-OC通信实际上很简单，OC向JS传信息有现成的接口，像webview提供的-stringByEvaluatingJavaScriptFromString方法可以直接在当前context上执行一段JS脚本，并且可以获取执行后的返回值，这个返回值就相当于JS向OC传递信息。React Native也是以此为基础，通过各种手段，实现了在OC定义一个模块方法，JS可以直接调用这个模块方法并还可以无缝衔接回调。</p>
<h3 id="RN-与-Objective-C-之间的通信"><a href="#RN-与-Objective-C-之间的通信" class="headerlink" title="RN 与 Objective-C 之间的通信"></a>RN 与 Objective-C 之间的通信</h3><p>Objective-C 和 JavaScript 两端都保存了一份配置表，里面标记了所有 Objective-C 暴露给 JavaScript 的模块和方法。这样，无论是哪一方调用另一方的方法，实际上传递的数据只有 ModuleId、MethodId 和 Arguments<br> 这三个元素，它们分别表示类、方法和方法参数，当 Objective-C 接收到这三个值后，就可以通过 runtime 唯一确定要调用的是哪个函数，然后调用这个函数。</p>
<p>这里有一个<strong>模块配置表</strong>的概念<br>首先OC要告知JS它有什么模块，模块内的方法，参数。JS知道后才可能去调用这些方法。<br>OC端和JS端分别各有一个bridge，两个bridge都保存了同样一份模块配置表，JS调用OC模块方法时，通过bridge里的配置表把模块方法转为模块ID和方法ID传给OC，OC通过bridge的模块配置表找到对应的方法执行</p>
<p>闭包与回调<br>既然说到函数互调，那么就不得不提到回调了。对于 Objective-C 来说，执行完 JavaScript 代码再执行 Objective-C 回调毫无难度，难点依然在于 JavaScript 代码调用 Objective-C 之后，如何在 Objective-C 的代码中，回调执行 JavaScript 代码。<br>目前 React Native 的做法是：在 JavaScript 调用 Objective-C 代码时，注册要回调的 Block，并且把 BlockId<br> 作为参数发送给 Objective-C，Objective-C 收到参数时会创建 Block，调用完 Objective-C 函数后就会执行这个刚刚创建的 Block。<br>Objective-C 会向 Block 中传入参数和 BlockId<br>，然后在 Block 内部调用 JavaScript 的方法，随后 JavaScript 查找到当时注册的 Block 并执</p>
<p>看完原理我们来看一下React Native的源码，我的RN Version 是0.44</p>
<p>首先程序入口在AppDelegate中,我去掉了部分源码，我们只看有用的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">NSURL *jsCodeLocation = [[RCTBundleURLProvider sharedSettings] jsBundleURLForBundleRoot:@&quot;index.ios&quot; fallbackResource:nil];</div><div class="line"></div><div class="line">RCTRootView *rootView = [[RCTRootView alloc] initWithBundleURL:jsCodeLocation</div><div class="line">                                                      moduleName:@&quot;AwesomeProject&quot;</div><div class="line">                                               initialProperties:nil</div><div class="line">                                                   launchOptions:launchOptions];</div></pre></td></tr></table></figure>
<p>进入 <strong>jsBundleURLForBundleRoot</strong> 方法我们来看一下内部的实现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">- (NSURL *)jsBundleURLForBundleRoot:(NSString *)bundleRoot fallbackResource:(NSString *)resourceName</div><div class="line">&#123;</div><div class="line">  resourceName = resourceName ?: @&quot;main&quot;;</div><div class="line">  NSString *packagerServerHost = [self packagerServerHost];</div><div class="line">  if (!packagerServerHost) &#123;</div><div class="line">    return [[NSBundle mainBundle] URLForResource:resourceName withExtension:@&quot;jsbundle&quot;];</div><div class="line">  &#125; else &#123;</div><div class="line">    NSString *path = [NSString stringWithFormat:@&quot;/%@.bundle&quot;, bundleRoot];</div><div class="line">    // When we support only iOS 8 and above, use queryItems for a better API.</div><div class="line">    NSString *query = [NSString stringWithFormat:@&quot;platform=ios&amp;dev=%@&amp;minify=%@&quot;,</div><div class="line">                       [self enableDev] ? @&quot;true&quot; : @&quot;false&quot;,</div><div class="line">                       [self enableMinification] ? @&quot;true&quot;: @&quot;false&quot;];</div><div class="line">    return [[self class] resourceURLForResourcePath:path packagerHost:packagerServerHost query:query];</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个方法创建了一个本地的js文件访问URL.<br>继续向下走</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">- (instancetype)initWithBundleURL:(NSURL *)bundleURL</div><div class="line">                       moduleName:(NSString *)moduleName</div><div class="line">                initialProperties:(NSDictionary *)initialProperties</div><div class="line">                    launchOptions:(NSDictionary *)launchOptions</div><div class="line">&#123;</div><div class="line">  RCTBridge *bridge = [[RCTBridge alloc] initWithBundleURL:bundleURL</div><div class="line">                                            moduleProvider:nil</div><div class="line">                                             launchOptions:launchOptions];</div><div class="line"></div><div class="line">  return [self initWithBridge:bridge moduleName:moduleName initialProperties:initialProperties];</div><div class="line">&#125;</div><div class="line"></div><div class="line">initWithBundleURL参数分析</div><div class="line">**bundleURL : 初始化是我们创建的URL</div><div class="line">moduleProvider : 此块可用于实例化需要额外的模块(这一块我们后期再深入的了解，先留一个疑问，暂时不传)</div><div class="line">launchOptions : 加载的参数**</div></pre></td></tr></table></figure>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>此时我们的线程是保持在主线程中执行,在setUp方法中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">void RCTExecuteOnMainQueue(dispatch_block_t block)</div><div class="line">&#123;</div><div class="line">  if (RCTIsMainQueue()) &#123;</div><div class="line">    block();</div><div class="line">  &#125; else &#123;</div><div class="line">    dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">      block();</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>首先创建了一个RCTBridge对象，通过文档我们知道，它是一个异步批量链接JavaScript应用程序通信。<br><strong>Async batched bridge used to communicate with the JavaScript application.</strong><br><strong>RCTBridge</strong>对象起到了桥接两端的作用,具体实现要在RCTBatchedBridge 类中的 <strong>start</strong>方法内, start中执行了重要的初始化任务,也是RN的精髓,基于大量的GCD实现了异步初始化组件框架的任务.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line">- (void)start</div><div class="line">&#123;</div><div class="line">  //将要开始加载的通知</div><div class="line">  [[NSNotificationCenter defaultCenter]</div><div class="line">    postNotificationName:RCTJavaScriptWillStartLoadingNotification</div><div class="line">    object:_parentBridge userInfo:@&#123;@&quot;bridge&quot;: self&#125;];</div><div class="line"></div><div class="line">  //为事件收集初始事件信息并返回引用ID</div><div class="line">  RCT_PROFILE_BEGIN_EVENT(0, @&quot;-[RCTBatchedBridge setUp]&quot;, nil);</div><div class="line"></div><div class="line">  dispatch_queue_t bridgeQueue = dispatch_queue_create(&quot;com.facebook.react.RCTBridgeQueue&quot;, DISPATCH_QUEUE_CONCURRENT);</div><div class="line"></div><div class="line">  dispatch_group_t initModulesAndLoadSource = dispatch_group_create();</div><div class="line"></div><div class="line">  // Asynchronously load source code</div><div class="line">  dispatch_group_enter(initModulesAndLoadSource);</div><div class="line">  __weak RCTBatchedBridge *weakSelf = self;</div><div class="line">  __block NSData *sourceCode;</div><div class="line">  // RCTMultipartDataTask 类做网络请求, 基于NSURLSession, 获得javascript data</div><div class="line">  [self loadSource:^(NSError *error, NSData *source, __unused int64_t sourceLength) &#123;</div><div class="line">    if (error) &#123;</div><div class="line">      RCTLogWarn(@&quot;Failed to load source: %@&quot;, error);</div><div class="line">      dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">        [weakSelf stopLoadingWithError:error];</div><div class="line">      &#125;);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    sourceCode = source;</div><div class="line">    dispatch_group_leave(initModulesAndLoadSource);</div><div class="line">  &#125; onProgress:^(RCTLoadingProgress *progressData) &#123;</div><div class="line">#if RCT_DEV &amp;&amp; __has_include(&quot;RCTDevLoadingView.h&quot;)</div><div class="line">    RCTDevLoadingView *loadingView = [weakSelf moduleForClass:[RCTDevLoadingView class]];</div><div class="line">    [loadingView updateProgress:progressData];</div><div class="line">#endif</div><div class="line">  &#125;];</div><div class="line"></div><div class="line">  // 同步初始化所有不能被懒惰加载的本机模块</div><div class="line">  // Synchronously initialize all native modules that cannot be loaded lazily</div><div class="line">  [self initModulesWithDispatchGroup:initModulesAndLoadSource];</div><div class="line"></div><div class="line">  RCTPerformanceLogger *performanceLogger = self-&gt;_performanceLogger;</div><div class="line">  __block NSString *config;</div><div class="line">  dispatch_group_enter(initModulesAndLoadSource);</div><div class="line">  dispatch_async(bridgeQueue, ^&#123;</div><div class="line">    dispatch_group_t setupJSExecutorAndModuleConfig = dispatch_group_create();</div><div class="line"></div><div class="line">    // Asynchronously initialize the JS executor</div><div class="line">    dispatch_group_async(setupJSExecutorAndModuleConfig, bridgeQueue, ^&#123;</div><div class="line">      [performanceLogger markStartForTag:RCTPLJSCExecutorSetup];</div><div class="line">      [weakSelf setUpExecutor];</div><div class="line">      [performanceLogger markStopForTag:RCTPLJSCExecutorSetup];</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    // Asynchronously gather the module config</div><div class="line">    dispatch_group_async(setupJSExecutorAndModuleConfig, bridgeQueue, ^&#123;</div><div class="line">      if (weakSelf.valid) &#123;</div><div class="line">        RCT_PROFILE_BEGIN_EVENT(0, @&quot;-[RCTBatchedBridge moduleConfig&quot;, nil);</div><div class="line">        [performanceLogger markStartForTag:RCTPLNativeModulePrepareConfig];</div><div class="line">        config = [weakSelf moduleConfig];</div><div class="line">        [performanceLogger markStopForTag:RCTPLNativeModulePrepareConfig];</div><div class="line">        RCT_PROFILE_END_EVENT(RCTProfileTagAlways, @&quot;&quot;);</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    dispatch_group_notify(setupJSExecutorAndModuleConfig, bridgeQueue, ^&#123;</div><div class="line">      // We&apos;re not waiting for this to complete to leave dispatch group, since</div><div class="line">      // injectJSONConfiguration and executeSourceCode will schedule operations</div><div class="line">      // on the same queue anyway.</div><div class="line">      //利用 javaScriptCore 引擎为 native 设置方法和属性</div><div class="line">      [performanceLogger markStartForTag:RCTPLNativeModuleInjectConfig];</div><div class="line">      [weakSelf injectJSONConfiguration:config onComplete:^(NSError *error) &#123;</div><div class="line">        [performanceLogger markStopForTag:RCTPLNativeModuleInjectConfig];</div><div class="line">        if (error) &#123;</div><div class="line">          RCTLogWarn(@&quot;Failed to inject config: %@&quot;, error);</div><div class="line">          dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">            [weakSelf stopLoadingWithError:error];</div><div class="line">          &#125;);</div><div class="line">        &#125;</div><div class="line">      &#125;];</div><div class="line">      dispatch_group_leave(initModulesAndLoadSource);</div><div class="line">    &#125;);</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  //拿到请求后的javascript data 进行解码</div><div class="line">  dispatch_group_notify(initModulesAndLoadSource, bridgeQueue, ^&#123;</div><div class="line">    RCTBatchedBridge *strongSelf = weakSelf;</div><div class="line">    if (sourceCode &amp;&amp; strongSelf.loading) &#123;</div><div class="line">      [strongSelf executeSourceCode:sourceCode];</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  RCT_PROFILE_END_EVENT(RCTProfileTagAlways, @&quot;&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>基本流程图</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1481580-e585b5430a581b2d.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="RN启动流程.png"></p>
<p>启动流程部分大概就这样，理解了从加载URL/local path 到 通过 jsCore引擎来加载到应用层的基本逻辑，后面继续探索他的原理以及其他的使用技巧，<strong>理解原理后才能更好的去使用RN</strong><br>下面就是将RN应用到自己的项目中开始AwesomeProject 之旅</p>
<p>有问题欢迎评论指正，我会及时进行修改。</p>
<h3 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h3><p><a href="http://lib.csdn.net/xiangzhihong8/5375/chart/React%20Native" target="_blank" rel="external">React Native 知识库</a><br><a href="http://blog.cnbang.net/tech/2698/" target="_blank" rel="external">React Native通信机制详解</a><br><a href="http://www.jianshu.com/p/978c4bd3a759" target="_blank" rel="external">React Native 从入门到原理</a><br><a href="http://blog.csdn.net/xiangzhihong8/article/details/52623852" target="_blank" rel="external">React Native运行原理解析 android</a><br><a href="https://github.com/crazycodeboy/RNStudyNotes/blob/master/React%20Native%E5%8E%9F%E7%94%9F%E7%BB%84%E4%BB%B6%E5%BC%80%E5%8F%91/React%20Native%20%E4%B8%8E%20iOS%20%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8%E9%97%B4%E9%80%9A%E4%BF%A1.md" target="_blank" rel="external">React-Native 与 iOS原生项目间通信(已有项目添加RN)</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="Haonan Cui deployment" />
          <p class="site-author-name" itemprop="name">Haonan Cui deployment</p>
           
              <p class="site-description motion-element" itemprop="description">IOS开发，喜欢刨根问底，热爱技术，热爱Swift、React-Native、JS，混合开发。</p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">11</span>
                <span class="site-state-item-name">posting</span>
              </a>
            </div>
          

          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">tags</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Haonan Cui deployment</span>
</div>


<div class="powered-by">
  Powered by <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Tema -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  





  






  





  

  

  

  

  

</body>
</html>
